{% extends 'base.html' %}
{% load static   %}
{% load assistant_tags %}
{% load humanize %}

{% block head_title %} Generate Blog {% endblock %}
{% block breadcrumb%}
<h2 class="text-title-md2 font-bold text-black dark:text-white">
    Blog Generation
</h2>

<nav>
    <ol class="flex items-center gap-2">
        <li>
            <a class="font-medium" href="{% url 'home' %}">Dashboard /</a>
        </li>
        <li class="font-medium text-primary">Blog Generation</li>
    </ol>
</nav>
{% endblock%}
{% block content %}





<!--Forms Section Start-->
<div class="rounded-sm border border-stroke bg-white shadow-default dark:border-strokedark dark:bg-boxdark" x-data="{showOutput:false}">
    <div class="w-full border-stroke dark:border-strokedark">
        <div class="w-full p-4">
            <div class="flex gap-16">
                <!-- First Section -->
                <div class="w-4/12">
                  <div x-data="{ isDragging: false, initialY: 0, currentY: 0, showScrollbar: false, onMouseMove: function(event) { /* Define your behavior here */ }, onMouseUp: function() { /* Define your behavior here */ } }"
         x-init="() => { window.addEventListener('mousemove', onMouseMove); window.addEventListener('mouseup', onMouseUp); }"
         x-on:mousedown.prevent="isDragging = true; initialY = $event.clientY; currentY = $event.clientY"
         x-on:mouseleave.window="isDragging = false"
         x-on:mouseup.window="isDragging = false"
         x-on:mouseenter="showScrollbar = true"
         x-on:mouseleave="showScrollbar = false"
         :class="{ 'overflow-y-auto': showScrollbar, 'overflow-y-hidden': !showScrollbar }"
         style="width: 20rem; height: 20rem; padding: 1rem; cursor: grab;">
        <div class="text-center text-xl font-semibold mb-4">History</div>
        <div class="p-4 bg-gray-100 rounded-md">
            <ul>
                {% for date, blogs in blogs_grouped_by_date.items %}
                <h2 class="text-sm font-bold mb-4">{{ date |  naturalday | title}}</h2>
                {% for blog in blogs %}
                <a href="{% url 'details' blog.id %}" class="block">
                    <li class="mb-2">{{ blog.title | get_first_four_words}}</li>
                </a>
                {% empty %}
                <li class="text-gray-500">No blogs found.</li>
                {% endfor %}
                <br>
                {% endfor %}
                
            </ul>
        </div>
        
        </div>
              </div>
              
                <!-- Second Section -->
                <div class="w-full sm:w-8/12 rounded-lg p-6">
                    <h1 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Generate Blog</h1>
                    
                    <form method="post" id="blogForm"> 
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            {{ form.prompt}}
                            {% if form.prompt.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.prompt.errors }}</div>
                            {% endif %}
                        </div>
                        
                        
                        {% if form.non_field_errors %}
                        <div class="mb-4">
                            {% for error in form.non_field_errors %}
                            <div class="text-red-500 text-sm">{{ error }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <div class="flex">
                            <input type="submit" value="Generate" class="w-full sm:w-auto px-6 py-2 bg-primary text-white rounded-md font-medium transition hover:bg-opacity-90">
                        </div>
                    </form>
                </div>
                
                
                
                

            <div x-data="{ popupOpen: false }" class="relative z-999 ">
              <!-- Icon Button -->
             
              <button title=" Configuration Settings" @click="popupOpen = true" type="button" class="inline-flex items-center gap-x-1 text-sm font-semibold leading-6 text-gray-900 bg-gray-100 px-3 py-2 rounded shadow">
                  <span class="relative">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.149.894c.07.424.384.764.78.93.398.164.855.142 1.205-.108l.737-.527a1.125 1.125 0 0 1 1.45.12l.773.774c.39.389.44 1.002.12 1.45l-.527.737c-.25.35-.272.806-.107 1.204.165.397.505.71.93.78l.893.15c.543.09.94.559.94 1.109v1.094c0 .55-.397 1.02-.94 1.11l-.894.149c-.424.07-.764.383-.929.78-.165.398-.143.854.107 1.204l.527.738c.32.447.269 1.06-.12 1.45l-.774.773a1.125 1.125 0 0 1-1.449.12l-.738-.527c-.35-.25-.806-.272-1.203-.107-.398.165-.71.505-.781.929l-.149.894c-.09.542-.56.94-1.11.94h-1.094c-.55 0-1.019-.398-1.11-.94l-.148-.894c-.071-.424-.384-.764-.781-.93-.398-.164-.854-.142-1.204.108l-.738.527c-.447.32-1.06.269-1.45-.12l-.773-.774a1.125 1.125 0 0 1-.12-1.45l.527-.737c.25-.35.272-.806.108-1.204-.165-.397-.506-.71-.93-.78l-.894-.15c-.542-.09-.94-.56-.94-1.109v-1.094c0-.55.398-1.02.94-1.11l.894-.149c.424-.07.765-.383.93-.78.165-.398.143-.854-.108-1.204l-.526-.738a1.125 1.125 0 0 1 .12-1.45l.773-.773a1.125 1.125 0 0 1 1.45-.12l.737.527c.35.25.807.272 1.204.107.397-.165.71-.505.78-.929l.15-.894Z" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                      </svg>
                  </span>
              </button>
           
          
              <!-- Overlay -->
              <div x-show="popupOpen" class="fixed inset-0 bg-black opacity-50 z-40 transition-opacity"></div>
          
              <div x-show="popupOpen" class="fixed inset-0 flex items-center justify-center z-50">
                  <!-- Popup -->
                  <div class="bg-white p-6 rounded shadow-lg w-80 relative  dark:border-strokedark dark:bg-boxdark">
                      <!-- Close Button -->
                      <button @click="popupOpen = false" class="absolute top-0 right-0 mt-2 mr-2 text-gray-500 hover:text-gray-700 focus:outline-none">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                          </svg>
                      </button>
                      
                      <h2 class="font-bold text-gray-900 mb-4">Generation Configuration Settings</h2>
                      
                      <form method="post">
                          {% csrf_token %}
                          <div class="space-y-4">
                              <div>
                                <div x-data="{ showTooltip: false }">
                                    <span class="relative cursor-pointer"
                                          @mouseenter="showTooltip = true"
                                          @mouseleave="showTooltip = false">
                                          <label class="text-sm font-semibold leading-6 text-gray-900 flex items-center">
                                           Model
                                        </label>
                                        <div x-show="showTooltip" class="absolute z-10 bg-graydark text-white  shadow-md p-4 w-60 h-auto max-h-48 overflow-y-auto mt-2 rounded">
                                            <p class="text-xs">
                                                The model which will generate the completion. Some models are suitable for natural language tasks, others specialize in code.
                                            </p>
                                        </div>
                                    </span>
                                </div>
                                  <div>
                                      {{form2.model}}
                                      {% if form2.model.errors %}
                                      <p class="text-sm text-red-500">{{form2.model.errors}}</p>
                                      {% endif %}
                                  </div>
                              </div>
                              
                              <div>
                                <div x-data="{ showTooltip: false }">
                                    <span class="relative cursor-pointer"
                                          @mouseenter="showTooltip = true"
                                          @mouseleave="showTooltip = false">
                                          <label class="text-sm font-semibold leading-6 text-gray-900 flex items-center">
                                           Temperature
                                        </label>
                                        <div x-show="showTooltip" class="absolute z-10 bg-graydark text-white  shadow-md p-4 w-60 h-auto max-h-48 overflow-y-auto mt-2 rounded">
                                            <p class="text-xs">
                                                Controls randomness: Lowering results in less random completions. As the
                                                temperature approaches zero, the model
                                                will become deterministic and repetitive.                                            </p>
                                        </div>
                                    </span>
                                </div>
                                  <div>
                                      {{form2.temperature}}
                                      {% if form2.temperature.errors %}
                                      <p class="text-sm text-red-500">{{form2.temperature.errors}}</p>
                                      {% endif %}
                                  </div>
                              </div>
                              
                              <div>
                                <div x-data="{ showTooltip: false }">
                                    <span class="relative cursor-pointer"
                                          @mouseenter="showTooltip = true"
                                          @mouseleave="showTooltip = false">
                                          <label class="text-sm font-semibold leading-6 text-gray-900 flex items-center">
                                           Top P
                                        </label>
                                        <div x-show="showTooltip" class="absolute z-10 bg-graydark text-white  shadow-md p-4 w-60 h-auto max-h-48 overflow-y-auto mt-2 rounded">
                                            <p class="text-xs">

                                                Controls diversity via nucleus sampling: 0.5 means half of all likelihood-weighted options are considered.                                            </p>
                                        </div>
                                    </span>
                                </div>                                  <div>
                                      {{form2.top_p}}
                                      {% if form2.top_p.errors %}
                                      <p class="text-sm text-red-500">{{form2.top_p.errors}}</p>
                                      {% endif %}
                                  </div>
                              </div>
                              
                              
                              
                              <div>
                                <div x-data="{ showTooltip: false }">
                                    <span class="relative cursor-pointer"
                                          @mouseenter="showTooltip = true"
                                          @mouseleave="showTooltip = false">
                                          <label class="text-sm font-semibold leading-6 text-gray-900 flex items-center">
                                          Max Output Tokens
                                        </label>
                                        <div x-show="showTooltip" class="absolute z-10 bg-graydark text-white  shadow-md p-4 w-60 h-auto max-h-48 overflow-y-auto mt-2 rounded">
                                            <p class="text-xs">

                                                The maximum number of tokens to generate shared between the prompt and completion. The exact limit varies by model. (One token is roughly 4 characters for standard English text)                                            </p>
                                        </div>
                                    </span>
                                </div>                                  
                                <div>
                                      {{form2.max_output_tokens}}
                                      {% if form2.max_output_tokens.errors %}
                                      <p class="text-sm text-red-500">{{form2.max_output_tokens.errors}}</p>
                                      {% endif %}
                                  </div>
                              </div>
                          </div>
          
                          {% if form2.non_field_errors %}
                          <div class="mt-4">
                              {% for error in form2.non_field_errors %}
                              <p class="text-sm text-red-500">{{error}}</p>
                              {% endfor %}
                          </div>
                          {% endif %}
          
                          <div class="mt-6 flex justify-end">
                              <input type="submit" value="Save" class="inline-flex items-center px-4 py-2 border border-transparent text-sm leading-5 font-medium rounded text-white bg-primary hover:bg-primary-dark focus:outline-none focus:border-primary focus:shadow-outline-primary active:bg-primary-dark transition ease-in-out duration-150" />
                          </div>
                      </form>
                  </div>
              </div>
          </div>
          
        </div>
        
    </div>
<!-- </div> -->
<!-- Form Section end -->

    <br>
    <br>
    <!-- Another section -->

    <div id="outputSection" style="display: none;">
    
        <!-- <div id="outputSection" x-show="showOutput"> -->
        <div class="flex flex-wrap items-center">
            <div class="w-full">
                <div class="px-6 py-8">
                    <div id="streamingContent" class="prose dark:prose-dark" >
                        <!-- loader -->
                        <div class="flex justify-center" id="loader">
                          
                            <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-e-transparent align-[-0.125em] text-surface motion-reduce:animate-[spin_1.5s_linear_infinite] dark:text-white" role="status">
                              <span class="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">Loading...</span>
                        
                            </div>
                            Hang In, Your Blog is being generated
                          </div>
                        <!-- loader -->
                    </div>
                </div>
                <form method="post" id="regenerateForm" style="display: none;">
                    {% csrf_token %}
                    <div class="mb-5 flex justify-end">
                        <button type="submit" name="action" value="regenerate" class="px-4 py-2 rounded-lg border border-primary bg-primary font-medium text-white transition hover:bg-opacity-90 mr-4">Regenerate</button>
                    </div>
                </form>
            </div>
        </div>
    <!-- </div> -->
        
</div> <!-- Main Div ends here  -->


    <!-- ====== Forms Section End -->

<script>
  function generateBlog() {
    var prompt = document.getElementById('id_prompt').value;
    

    var csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

    // var xhr = new XMLHttpRequest();
    // xhr.open('POST', '/blog/', true);  
    // xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    // xhr.setRequestHeader('X-CSRFToken', csrfToken);
    // xhr.onreadystatechange = function() {
    //   if (xhr.readyState === XMLHttpRequest.DONE) {
    //     if (xhr.status === 200) {
    //       // Update the content of streamingContent div with the response
    //       var response = xhr.responseText.trim();
    //       document.getElementById('streamingContent').innerHTML = response;
          
    //       var regenerateForm = document.getElementById('regenerateForm');
    //       regenerateForm.style.display = response ? 'block' : 'none';
    //     } else {
    //       // Handle error
    //       console.error('Error:', xhr.status);
    //     }
    //   }
    // };
    // xhr.send('prompt=' + encodeURIComponent(prompt));
  }


  document.getElementById('blogForm').addEventListener('submit', function(event) {
    event.preventDefault(); 
    var outputSection = document.getElementById('outputSection');
    outputSection.style.display = 'block'
   
   

    generateBlog(); 
  });

 
  document.getElementById('regenerateForm').addEventListener('submit', function(event) {
    event.preventDefault(); 
    document.getElementById('streamingContent').innerHTML = '';
    var outputSection = document.getElementById('outputSection');
    outputSection.style.display = 'block'
    generateBlog(); 
  });
</script>

<style>
  /* Custom scrollbar */
  ::-webkit-scrollbar {
      width: 5px;
  }
  ::-webkit-scrollbar-track {
      background: #f1f1f1;
  }
  ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
  }
  ::-webkit-scrollbar-thumb:hover {
      background: #555;
  }
</style>

    
 

  


    {% endblock content %}
